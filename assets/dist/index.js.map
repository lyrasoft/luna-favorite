{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  useHttpClient,\n  simpleAlert,\n  useBs5Tooltip,\n  useUniDirective,\n  module,\n  data, removeData\n} from '@windwalker-io/unicorn-next';\n\nexport class FavoriteButtonHandler {\n  protected el: HTMLElement;\n  protected icon: HTMLElement;\n  protected added: boolean;\n  protected type: string;\n  protected id: string;\n\n  constructor(el: HTMLElement) {\n\n    this.el = el!;\n    this.icon = el.querySelector('i, span')!;\n    this.added = el.dataset.added === '1' || el.dataset.added === 'true';\n    this.type = el.dataset.type!;\n    this.id = el.dataset.id!;\n\n    this.el.addEventListener('click', this.onClick.bind(this));\n\n    this.refreshStyle();\n  }\n\n  off() {\n    this.el.removeEventListener('click', this.onClick);\n  }\n\n  private async onClick() {\n    await this.toggleFavorite();\n    this.refreshStyle();\n  }\n\n  async toggleFavorite() {\n    const favData = data('favorite');\n\n    if (!favData.isLogin) {\n      location.href = favData.loginUri;\n      return;\n    }\n\n    const task = this.added ? 'removeFavorite' : 'addFavorite';\n    const { post, isAxiosError } = await useHttpClient();\n    try {\n\n      const res = await post(\n        `@favorite_ajax/${task}`,\n        {\n          id: this.id,\n          type: this.type,\n        }\n      );\n\n      this.el.dispatchEvent(\n        new CustomEvent('favorited', {\n          detail: {\n            favorited: !this.added,\n            task,\n            type: this.type,\n            message: res.data.message,\n          },\n          bubbles: true\n        })\n      );\n\n      this.added = !this.added;\n      this.el.dataset.added = this.added ? '1' : '0';\n    } catch (e) {\n      if (isAxiosError(e)) {\n        await simpleAlert(e.message, '', 'warning');\n      }\n\n      console.error(e);\n      throw e;\n    }\n  }\n\n  refreshStyle() {\n    if (this.el.dataset.classInactive || this.el.dataset.classActive) {\n      this.el.classList.remove(\n        ...this.classToList(this.el.dataset.classInactive!),\n        ...this.classToList(this.el.dataset.classActive!)\n      );\n    }\n\n    if (this.added) {\n      this.icon.setAttribute('class', this.el.dataset.iconActive!);\n\n      if (this.el.dataset.classActive) {\n        this.el.classList.add(\n          ...this.classToList(this.el.dataset.classActive)\n        );\n      }\n\n      this.el.setAttribute('data-bs-original-title', this.el.dataset.titleActive!);\n    } else {\n      this.icon.setAttribute('class', this.el.dataset.iconInactive!);\n\n      if (this.el.dataset.classInactive) {\n        this.el.classList.add(\n          ...this.classToList(this.el.dataset.classInactive)\n        );\n      }\n\n      this.el.setAttribute('data-bs-original-title', this.el.dataset.titleInactive!);\n    }\n\n    setTimeout(async () => {\n      const tooltip = await useBs5Tooltip(this.el);\n\n      tooltip[0].update();\n    }, 50);\n  }\n\n  /**\n   * @param {string} className\n   * @returns {string[]}\n   */\n  classToList(className: string): string[] {\n    return className.split(' ');\n  }\n}\n\nasync function init() {\n  return useUniDirective<HTMLElement>(\n    'favorite-button',\n    {\n      mounted(el) {\n        setTimeout(() => {\n          module(el, 'favorite.button', (el) => new FavoriteButtonHandler(el));\n        }, 0);\n      },\n      unmounted(el) {\n        const instance = module<FavoriteButtonHandler>(el, 'favorite.button');\n\n        instance?.off();\n\n        removeData(el, 'favorite.button');\n      }\n    }\n  );\n}\n\nexport function useFavoriteButton() {\n  return useUniDirective<HTMLElement>(\n    'favorite-button',\n    {\n      mounted(el) {\n        setTimeout(() => {\n          module(el, 'favorite.button', (el) => new FavoriteButtonHandler(el));\n        }, 0);\n      },\n      unmounted(el) {\n        const instance = module<FavoriteButtonHandler>(el, 'favorite.button');\n\n        instance?.off();\n\n        removeData(el, 'favorite.button');\n      }\n    }\n  );\n}\n"],"names":["el"],"mappings":"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"}